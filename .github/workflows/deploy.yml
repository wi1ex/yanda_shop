name: Deploy on push to main

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      BACKEND_URL:         ${{ secrets.BACKEND_URL }}
      BOT_TOKEN:           ${{ secrets.BOT_TOKEN }}
      SECRET_KEY:          ${{ secrets.SECRET_KEY }}
      JWT_SECRET_KEY:      ${{ secrets.JWT_SECRET_KEY }}

      DB_HOST:             ${{ secrets.DB_HOST }}
      DB_PORT:             ${{ secrets.DB_PORT }}
      DB_NAME:             ${{ secrets.DB_NAME }}
      DB_USER:             ${{ secrets.DB_USER }}
      DB_PASSWORD:         ${{ secrets.DB_PASSWORD }}

      REDIS_HOST:          ${{ secrets.REDIS_HOST }}
      REDIS_PORT:          ${{ secrets.REDIS_PORT }}
      REDIS_PASSWORD:      ${{ secrets.REDIS_PASSWORD }}

      MINIO_HOST:          ${{ secrets.MINIO_HOST }}
      MINIO_BUCKET:        ${{ secrets.MINIO_BUCKET }}
      MINIO_ROOT_USER:     ${{ secrets.MINIO_ROOT_USER }}
      MINIO_ROOT_PASSWORD: ${{ secrets.MINIO_ROOT_PASSWORD }}

      MAIL_PORT:           ${{ secrets.MAIL_PORT }}
      MAIL_SERVER:         ${{ secrets.MAIL_SERVER }}
      MAIL_USERNAME:       ${{ secrets.MAIL_USERNAME }}
      MAIL_PASSWORD:       ${{ secrets.MAIL_PASSWORD }}
      MAIL_USE_TLS:        ${{ secrets.MAIL_USE_TLS }}
      MAIL_DEFAULT_SENDER: ${{ secrets.MAIL_DEFAULT_SENDER }}

      OVERRIDE_HOSTNAME:   ${{ secrets.OVERRIDE_HOSTNAME }}
      DKIM_SELECTOR:       ${{ secrets.DKIM_SELECTOR }}
      POSTMASTER_ADDRESS:  ${{ secrets.POSTMASTER_ADDRESS }}
      ENABLE_SPAMASSASSIN: ${{ secrets.ENABLE_SPAMASSASSIN }}
      ENABLE_CLAMAV:       ${{ secrets.ENABLE_CLAMAV }}
      ENABLE_AMAVIS:       ${{ secrets.ENABLE_AMAVIS }}
      ENABLE_POSTGREY:     ${{ secrets.ENABLE_POSTGREY }}
      ONE_DIR:             ${{ secrets.ONE_DIR }}
      DMS_DEBUG:           ${{ secrets.DMS_DEBUG }}
      LOG_LEVEL:           ${{ secrets.LOG_LEVEL }}

      SSL_TYPE:            ${{ secrets.SSL_TYPE }}
      SSL_CERT_PATH:       ${{ secrets.SSL_CERT_PATH }}
      SSL_KEY_PATH:        ${{ secrets.SSL_KEY_PATH }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Write SSH key and known_hosts
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          echo "${{ secrets.SSH_KNOWN_HOSTS }}" > ~/.ssh/known_hosts
          chmod 600 ~/.ssh/known_hosts
        shell: bash

      - name: Create .env from Secrets
        run: |
          cat > .env <<EOF
          BACKEND_URL=${BACKEND_URL}
          BOT_TOKEN=${BOT_TOKEN}
          SECRET_KEY=${SECRET_KEY}
          JWT_SECRET_KEY=${JWT_SECRET_KEY}
          
          DB_HOST=${DB_HOST}
          DB_PORT=${DB_PORT}
          DB_NAME=${DB_NAME}
          DB_USER=${DB_USER}
          DB_PASSWORD=${DB_PASSWORD}
          
          REDIS_HOST=${REDIS_HOST}
          REDIS_PORT=${REDIS_PORT}
          REDIS_PASSWORD=${REDIS_PASSWORD}
          
          MINIO_HOST=${MINIO_HOST}
          MINIO_BUCKET=${MINIO_BUCKET}
          MINIO_ROOT_USER=${MINIO_ROOT_USER}
          MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD}
          
          MAIL_PORT=${MAIL_PORT}
          MAIL_SERVER=${MAIL_SERVER}
          MAIL_USERNAME=${MAIL_USERNAME}
          MAIL_PASSWORD=${MAIL_PASSWORD}
          MAIL_USE_TLS=${MAIL_USE_TLS}
          MAIL_DEFAULT_SENDER=${MAIL_DEFAULT_SENDER}
          
          OVERRIDE_HOSTNAME=${OVERRIDE_HOSTNAME}
          DKIM_SELECTOR=${DKIM_SELECTOR}
          POSTMASTER_ADDRESS=${POSTMASTER_ADDRESS}
          ENABLE_SPAMASSASSIN=${ENABLE_SPAMASSASSIN}
          ENABLE_CLAMAV=${ENABLE_CLAMAV}
          ENABLE_AMAVIS=${ENABLE_AMAVIS}
          ENABLE_POSTGREY=${ENABLE_POSTGREY}
          ONE_DIR=${ONE_DIR}
          DMS_DEBUG=${DMS_DEBUG}
          LOG_LEVEL=${LOG_LEVEL}
          
          SSL_TYPE=${SSL_TYPE}
          SSL_CERT_PATH=${SSL_CERT_PATH}
          SSL_KEY_PATH=${SSL_KEY_PATH}
          EOF
        shell: bash

      - name: Copy .env to server
        run: |
          scp -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=yes \
            ./.env \
            "${{ secrets.SERVER_USER }}"@"${{ secrets.SERVER_HOST }}":/root/app/yanda_shop/.env
        shell: bash

      - name: Deploy via SSH
        run: |
          ssh -i ~/.ssh/deploy_key \
              -o StrictHostKeyChecking=yes \
              -l "${{ secrets.SERVER_USER }}" \
              "${{ secrets.SERVER_HOST }}" << 'EOF'
            set -euo pipefail
            cd /root/app/yanda_shop
            git fetch --all
            git reset --hard origin/main
            docker-compose down
            docker network prune --filter "until=24h" --force
            docker container prune --filter "until=24h" --force
            docker image prune --all --filter "until=24h" --force
            docker builder prune --all --filter "until=24h" --force
            certbot renew --noninteractive --standalone --agree-tos
            docker-compose build --no-cache
            docker-compose up -d
            docker-compose run --rm backend flask db upgrade
            docker-compose ps
          EOF
        shell: bash
